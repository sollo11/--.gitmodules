var __extends=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),__spreadArrays,WSB;(function(n){var r="NT",p="NF",t="https://substrate.office.com{0}/api/v1/",w=t+"events",o=t+"init",b=t+"suggestions?query=",k=t+"query",d=t+"recommendations",s="SubstrateSearchService",g="https://outlook.office365.com/autodiscover/autodiscover.json/v1.0/{0}?Protocol={1}",u="AutoDiscoveryKey",h="gwsflt.",nt="textdecorations",c="scenario",tt="setflight",it="debug",l="entitytypes",rt="1",ut="scopes",ft="people.directorysearch",et="Authorization",f="Content-Type",ot="X-AnchorMailbox",st="X-Client-Language",ht="X-Client-LocalTime",a="Client-Request-Id",v="User-Agent",ct="X-Debug-ExternalExp",lt="X-Client-Flights",e="application/json",at=15,vt=n.MinuteToMs,i,y=!1,yt=function(t){function yt(r,f,e,s,c){var p,l=t.call(this,c||yt.getDataSource(f,e))||this,w,a,k,b,v;return l._accessTokenManager=r,l._authType=f,l._providerType=e,l._storage=s,l._autoDiscoveryData={stem:"/search",timestamp:-1},y||(y=!0,a=[],k=function(n){return n.split(",").filter(function(n){return n.toLocaleLowerCase().startsWith(h)}).map(function(n){return n.substr(h.length)})},n.TestHookUrlParameters&&a.push.apply(a,((p=n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters["3sflights"])!==null&&p!==void 0?p:"").split(",")),i=a.join(","),ThresholdUtilities.getCortanaHeaders(function(n){var t,r;n&&(t=n["X-BM-ClientFeatures"],t&&(r=k(t),r.length>0&&(a.push.apply(a,r),i=a.join(","))))})),(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.clearAutoDCache)&&l._storage.removeItem(u),b=l._storage.getItem(u),b&&(v=n.safeExecute(function(){return JSON.parse(b)},"parseAutoDiscovery",null),v&&!v.errorState?l._autoDiscoveryData=v:l._storage.removeItem(u)),n.Host.bindAccessTokenAvailable(function(t){var r,f,i;if(t==l._authType){if(l._providerType==0){if(r=n.getCurrentTime(),w&&(f=r-w,f<vt))return;w=r;l.fetchUrl(o,null,"",function(){},null,function(){return!0})}i=n.getCurrentDate();i.setDate(i.getDate()-1);l._autoDiscoveryData.timestamp<i.getTime()&&l.getStem()(t,function(t){t.timestamp=n.getCurrentTime();l._autoDiscoveryData=t;t.errorState||l._storage.setItem(u,JSON.stringify(t))})}}),l}return __extends(yt,t),yt.prototype.getName=function(){return"SubstrateDataProvider "+this._dataSource},yt.prototype.createUrl=function(i){if(this._providerType==1||this._providerType==2)return this.getBaseUrl();if(this._providerType==0){if(i.scope==n.Scope.Documents){var r=n.getEffectiveQuery(i);if(r!=i.queryToFetch)return this.getBaseUrl()+n.encodeQueryParameter(r.toLocaleLowerCase())}return t.prototype.createUrl.call(this,i)}throw new Error("Not implemented");},yt.prototype.getBaseUrl=function(){if(this._providerType==0)return b;if(this._providerType==1)return k;if(this._providerType==2)return d;throw new Error("Not implemented");},yt.prototype.getClientFlights=function(){return this._providerType==2?"recv0hack":null},yt.getDataSource=function(n,t){if(t==0)return n==1?"SSUE":"SSUC";if(t==1)return n==1?"SSEE":"SSEC";if(t==2&&n==1)return"SREE";throw new Error("Not implemented");},yt.prototype.getPostBody=function(t){var r,u,f,i;if(this._providerType==1){r=void 0;u=n.getEffectiveScope(t);switch(u){case n.Scope.Emails:f=[{Score:{SortDirection:"Desc",Count:n.config.maxNumberOfEmailsInTopResult}},{Time:{SortDirection:"Desc"}}];r=this.buildPostBodyForQueryEndpoint(t,"Message",["Exchange"],f);break;case n.Scope.Documents:case n.Scope.All:i=void 0;switch(n.config.queryProvenances){case 0:i=["SharePoint"];break;case 1:i=["OneDriveBusiness"];break;case 2:i=["SharePoint","OneDriveBusiness"];break;default:throw new Error("Unexpected query provenances: "+n.config.queryProvenances);}r=this.buildPostBodyForQueryEndpoint(t,"Documents",i,[{Score:"Desc"}]);break;default:throw new Error("Unsupported scope "+t.scope);}return JSON.stringify(r)}return this._providerType==2?JSON.stringify(this.buildPostBodyForRecommendationsEndpoint()):""},yt.prototype.buildPostBodyForQueryEndpoint=function(n,t,i,r){return this.buildPostBody(t,"WindowsSearchBoxL2",undefined,n.queryToFetch,i,r,"ProvenanceOptimized","Forward")},yt.prototype.buildPostBodyForRecommendationsEndpoint=function(){var t=new Date(n.getCurrentTime()).toISOString(),i=new Date(n.getCurrentTime()+at*n.MinuteToMs).toISOString(),r=[{EntityType:"Event",StartDateTime:t,EndDateTime:i,Top:2},{EntityType:"Document",Top:4}];return this.buildPostBody("Document","WSB.MeetingRelatedEntities",r)},yt.prototype.buildPostBody=function(t,i,r,u,f,e,o,s){return{EntityRequests:[{Query:u?{QueryString:u}:undefined,QueryParameters:r,EntityType:t,Provenances:f,Sort:e,PropertySet:o}],Cvid:n.Host.getConversationId(),TextDecorations:s,Scenario:{Name:i}}},yt.prototype.getStem=function(){var i=this;return n.Promise.safeChainWithGlobalCaching("getStem",function(u){return ThresholdUtilities.createPromise(function(o){i._accessTokenManager.getAccount(u,n.getSubstrateResourceOrScope(u),!1,!0,function(u){var c,h,l;u&&u.UserName?(c=n.formatString(g,[u.UserName,s]),h={},h[f]=e,h[a]=n.Host.getConversationId(),h[v]=navigator.userAgent,l=function(t,i,r){var u,f,e;if(r){o({stem:"",errorState:r});return}if(u=i,!u){o({stem:""});return}if(!u.Url){o({stem:"",errorState:"NAU"});return}if(u.Protocol!=s){o({stem:"",errorState:"NAP"});return}if(f=n.tryParseUrl(u.Url,!0),e=f?f.path:null,!e){o({stem:"",errorState:"NAS"});return}o({stem:e})},t.prototype.fetchUrl.call(i,c,h,"",l,null,function(){return!0})):o({stem:"",errorState:r})})})},function(){return"autoDiscovery"})},yt.prototype.getAllAccountTokens=function(t,i){if(t||n.RuntimeConfig.QfMode!=5)this._accessTokenManager.getAccount(this._authType,n.getSubstrateResourceOrScope(this._authType),!1,!0,function(n){n&&n.Token?i([n]):i(null,r)});else{var u=SearchAppWrapper.CortanaApp.fileExplorerSuggestionPage.currentSyncRootAccount;u?this._accessTokenManager.getAccountByUserName(!0,1,u,!1,!0,function(n){n&&n.Token?i([n]):i(null,r)}):n.isFileExplorerCurrentPathThisPcOrQuickAccess?this._accessTokenManager.getAllSyncingAccounts(!0,1,!1,!0,function(n){n.length>0?i(n):i(null,r)}):(SharedLogHelper.LogError("fetchUrl",null,new Error("Substrate provider called without currentSyncRootAccount")),i(null,p))}},yt.prototype.fetchUrl=function(i,r,u,f,e,s){var c=this,a,h,l;if(!this._autoDiscoveryData.stem){f(this._dataSource,null,this._autoDiscoveryData.errorState,null,!0);return}a=i==o;i=n.formatString(i,[this._autoDiscoveryData.stem]);r||(r={});h={numOfPendingResponses:0};l=function(o){var l=Object.assign({},r);l[et]="Bearer "+o.Token;c._authType==1&&!n.SubstrateTenantName&&o.TenantName&&(n.SubstrateTenantName=o.TenantName);l[ot]=o.RoutingHint;t.prototype.fetchUrl.call(c,i,l,u,function(n,t,i,r,u){--h.numOfPendingResponses;f(n,t,i,r,u,h.numOfPendingResponses!=0)},e,s)};this.getAllAccountTokens(a,function(n,t){t?f(c._dataSource,null,t,null,null,!1):n?(h.numOfPendingResponses=n.length,n.forEach(function(n){return l(n)})):(h.numOfPendingResponses=1,l(null))})},yt.prototype.fetch=function(r,u,o,s,h,c){var w=this,y,b,p,k;n.isDataSourceEnabled(this._dataSource,r)&&(y={},y[st]=n.uiLanguageCache,y[ht]=n.getDateWithTimezone(),y[v]=navigator.userAgent,typeof _CachedFlights!="undefined"&&_CachedFlights.sort&&(y[ct]=_CachedFlights.sort().join(",")),y[a]=n.InstrumentationHelper.getImpressionGuid(o),y[f]=e,b=this.buildParams(c,r.scope,!r.queryToFetch),this._providerType!=0||b[l])&&(p=this.getClientFlights(),i&&(p=p?p+","+i:i),p&&(y[lt]=p),k=function(t,i,r,f,e,o){var s=parseInt(r);(s==403||s==401)&&n.safeSetTimeout(function(){return w._accessTokenManager.getAccount(w._authType,n.getSubstrateResourceOrScope(w._authType),!0,!0,function(){})},0,"SubstrateDataProvider onResponseReceived");u(t,i,r,f,e,o)},t.prototype.fetch.call(this,r,k,o,s,h,b,y))},yt.prototype.buildParams=function(t,i,r){var f,u={},e;return this._providerType==0&&(u[n.Service.QueryParams.ConversationId]=t[n.Service.QueryParams.ConversationId],u[nt]=rt,this._authType!=1||r||i!=n.Scope.People?i!=n.Scope.All&&(u[c]=ut):u[c]=ft,u[l]=this.getEntityTypes(i,r)),n.TestHookUrlParameters&&(e=(f=n.TestHookUrlParameters["3sflights"])!==null&&f!==void 0?f:"",e&&(u[tt]=e),n.TestHookUrlParameters["3sdebug"]&&(u[it]="1")),u},yt.prototype.getEntityTypes=function(t,i){var r,u,f;switch(t){case n.Scope.Documents:r="Documents";break;case n.Scope.People:r="People";break;case n.Scope.All:u=[];this._authType==1&&u.push("Documents");i||n.RuntimeConfig.QfMode==5||(f=typeof n.isTenantMsbEnabled=="function"&&n.isTenantMsbEnabled(),f||u.push("People"));r=u.join(",");break;default:throw new Error("Unsupported scope "+t);}return r},yt.prototype.instrumentClick=function(t,i){if(t&&i){var u=[{Key:t,Value:[{Name:"entityclicked",Attributes:[{Key:"id",Value:i},{Key:"localtime",Value:n.getDateWithTimezone()}]}]}],r={};r[f]=e;this.fetchUrl(w,r,JSON.stringify(u),function(){},null,function(){return!0})}},yt}(n.CortanaJsonDataProvider);n.SubstrateDataProvider=yt})(WSB||(WSB={})),function(n){function l(t,i,r){var u=n.OfficeTypeExtensionConfigs[t];u?n.LocalDataProvider.getApps(u.appIds,function(t){var f=!n.Map.isEmpty(t);f?i(u.uri):r()}):r()}function a(t,i,r){var u=t?new URL(t):null;!u||u.pathname&&u.pathname.indexOf(":")!=-1?n.Host.launchUri(i):l(r,function(i){return n.Host.launchUri(i+t)},function(){return n.Host.launchUri(i)})}function v(t,i,r){n.setExtraVerbs(t,function(){var u=[];return u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_OpenInBrowser],displayName:n.Host.getLocString("OpenInBrowser"),executeSync:function(){return n.Host.launchUri(i)},icon:{type:1,content:"&#xE774"}}),t.locationUrl&&u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_OpenFileLocationInBrowser],displayName:n.Host.getLocString("OpenFileLocationIn",r),executeSync:function(){return n.Host.launchUri(t.locationUrl)},icon:{type:2,content:"&#xE838"}}),t.url&&SearchAppWrapper.CortanaApp.copyToClipboard&&u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_CopyFullPath],displayName:n.Host.getLocString("CopyFullPath"),executeSync:function(){return SearchAppWrapper.CortanaApp.copyToClipboard(t.url,"")},icon:{type:1,content:"&#xE8C8"}}),u},!1)}function y(t,i,r,u){var e,s,h,f,o;r!="Exchange"&&(s=i.toLocaleLowerCase(),h=decodeURI(t.url).toLocaleLowerCase().indexOf(s),h!=-1&&(e=t.url.substr(0,h-1),s.endsWith(".one")&&(e=e.substr(0,e.lastIndexOf("/")))),f=decodeURI(t.url).split("/").slice(3),r=="OneDriveBusiness"?(o="OneDrive for Business:\\",f.length>2&&f[0].toLocaleLowerCase()=="personal"&&f[2].toLocaleLowerCase()=="documents"&&(f=f.slice(3))):o="SharePoint:\\",s.endsWith(".one")&&f.splice(f.length-2,1),t.path=o+f.join("\\"),u&&(r=="OneDriveBusiness"?o=n.Host.getLocString("OneDriveTitle",t.siteTitle):(o=t.siteTitle,f.length>1&&f[0].toLocaleLowerCase()=="teams"&&(f=f.slice(2))),t.prettyPrintedPath=o+" > "+f.join(" > ")),e&&(t.locationUrl=e))}function h(t,i,r,u,e,o,s,h,c,l,p,w,b,k,d,g,nt,tt,it,rt,ut){var lt=n.ScopeConfig[n.Scope.Documents].icon,ot,ft,st,at,et,vt,yt,ht,ct;return u||(u=r+"?web=1"),o=HitHighlightingParser.removeMarkers(o),s&&(s=s.toLocaleLowerCase()),ot="FL",ft=n.createSuggestion(i,e,n.getIconForTypeAsync(lt,"."+s),lt,ot,o,n.InstrumentedItem.createInstrumentedItem(g,ot),8,g,!0),ft.instrumentPingBack=d,ft.click=function(){return a(r,u,s)},ft.extensionLC="."+s,ft.lastModifiedDate=n.toDate(c),ft.lastModifiedBy=l,ft.lastAccessDate=n.toDate(p),ft.author=w,ft.matchedOnlyOnAuthor=b,ft.matchedOnlyOnContent=k,ft.textContentIfMatched=it,ft.siteTitle=ut,ft.url=r,st=h=="OneDriveBusiness"?3:h=="SharePoint"?4:undefined,at=n.nicerCloudFilesEnabled(i,ft),y(ft,o,h,at),b?ft.match=n.createMatch(n.MatchType.Author,w):e.includes(HitHighlightingParser.startMarker)||(ft.match=n.tryGetLocationMatch(ft.path,nt)||rt),i.isSearchHomeZI||(ft.sourceForGroup=st),et=new Date(n.getCurrentDate().toUTCString()),t?(ft.meeting=t,ft.features.push("MeetingRecommendation"),vt=new Date(t.Start),yt=Math.floor((vt.getTime()-et.getTime())/n.MinuteToMs),ft.explanation=yt>0?n.Host.getLocString("DocumentRelatedToMeeting",HitHighlightingParser.addMarkers(t.Subject.trim()),f(et,new Date(t.Start))):n.Host.getLocString("DocumentRelatedToMeetingNow",HitHighlightingParser.addMarkers(t.Subject.trim()))):i.isSearchHomeZI&&(ht=ft.lastModifiedBy&&ft.lastModifiedDate&&(!ft.lastAccessDate||ft.lastModifiedDate>=ft.lastAccessDate)?f(ft.lastModifiedDate,et):null,ht?ft.explanation=n.Host.getLocString("DocumentLastModifiedBy",HitHighlightingParser.addMarkers(ft.lastModifiedBy),ht):ft.lastAccessDate&&(ct=f(ft.lastAccessDate,et),ct&&(ft.explanation=n.Host.getLocString("DocumentLastAccessed",HitHighlightingParser.addMarkers(n.Host.getLocString("YouLabel")),ct)))),n.setFileTemplate(i,nt,tt,ft),v(ft,u,n.getGroupSourceDisplayName(st)),ft}function f(t,i){var r,u,f,e;return!t||!i?null:(r=i.getTime()-t.getTime(),r<0)?null:(u=r/n.DayToMs,u>=1)?n.Host.getLocString("TimeDayShorthandPattern",Math.floor(u).toString()):(f=r/n.HourToMs,f>=1)?n.Host.getLocString("TimeHourShorthandPattern",Math.floor(f).toString()):(e=r/n.MinuteToMs,n.Host.getLocString("TimeMinuteShorthandPattern",Math.floor(e).toString()))}var r={Word:{appIds:["Microsoft.Office.WINWORD.EXE.15","Microsoft.Office.WINWORD.EXE.16","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office15\\WINWORD.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office15\\WINWORD.EXE","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office16\\WINWORD.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office16\\WINWORD.EXE","Microsoft.Office.Word_8wekyb3d8bbwe!microsoft.word"],uri:"ms-word:ofe|u|"},Excel:{appIds:["Microsoft.Office.EXCEL.EXE.15","Microsoft.Office.EXCEL.EXE.16","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office15\\EXCEL.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office15\\EXCEL.EXE","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office16\\EXCEL.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office16\\EXCEL.EXE","Microsoft.Office.Excel_8wekyb3d8bbwe!microsoft.excel"],uri:"ms-excel:ofe|u|"},PowerPoint:{appIds:["Microsoft.Office.POWERPNT.EXE.15","Microsoft.Office.POWERPNT.EXE.16","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office15\\POWERPNT.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office15\\POWERPNT.EXE","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office16\\POWERPNT.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office16\\POWERPNT.EXE","Microsoft.Office.PowerPoint_8wekyb3d8bbwe!microsoft.pptim"],uri:"ms-powerpoint:ofe|u|"},Visio:{appIds:["{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office15\\VISIO.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office14\\VISIO.EXE","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office16\\VISIO.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office16\\VISIO.EXE","Microsoft.Office.VISIO.EXE.15"],uri:"ms-visio:ofe|u|"},OneNote:{appIds:["Microsoft.Office.ONENOTE.EXE.15","Microsoft.Office.ONENOTE.EXE.16","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office15\\ONENOTE.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office15\\ONENOTE.EXE","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office16\\ONENOTE.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office16\\ONENOTE.EXE","Microsoft.Office.OneNote_8wekyb3d8bbwe!microsoft.onenoteim"],uri:"onenote:"}},e="sip:",c=["Microsoft.Office.lync.exe.15","{6D809377-6AF0-444B-8957-A3773F02200E}Microsoft OfficeOffice15lync.exe","{6D809377-6AF0-444B-8957-A3773F02200E}Microsoft OfficeOffice16lync.exe","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}Microsoft OfficeOffice15lync.exe","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}Microsoft OfficeOffice16lync.exe","{6D809377-6AF0-444B-8957-A3773F02200E}MSOfficeOffice15lync.exe","{6D809377-6AF0-444B-8957-A3773F02200E}MSOfficeOffice16lync.exe","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}MSOfficeOffice15lync.exe","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}MSOfficeOffice16lync.exe","Microsoft.Office.Desktop_8wekyb3d8bbwe!Lync","com.squirrel.Teams.Teams",],t=r.Word,i=r.Excel,u=r.PowerPoint,o=r.Visio,s;n.OfficeTypeExtensionConfigs={doc:t,dot:t,dotx:t,docx:t,docm:t,docb:t,xls:i,xlm:i,xlsx:i,xlsm:i,xlsb:i,xltx:i,ppt:u,pps:u,pptx:u,pptm:u,vsd:o,vsdx:o,one:r.OneNote};s=function(){function t(n,t,i,r){this._substrateSuggestionsDataProvider=n;this._accessTokenManager=t;this._substrateProfilePictureProvider=i;this._authType=r;this._mailboxLocations={}}return t.prototype.parse=function(t,i,r,u,f,e){var s=this,o;if(n.isDataSourceEnabled(r,t)){if(o=[],!u||!u.Groups){e(r,o,null);return}var l=r=="SSUE"?n.config.aadPeopleCardHandoffEnabled&&!(typeof n.isTenantMsbEnabled=="function"&&n.isTenantMsbEnabled()):n.config.msaPeopleCardHandoffEnabled,y=n.getEffectiveQuery(t),a=n.isL2(t),v=function(c){for(var v,tt,it,w,g,rt,ut,k,nt,b,p=0,d=u.Groups;p<d.length;p++)if(v=d[p],v.Suggestions&&v.Suggestions.length)switch(v.Type){case"Documents":for(tt=v.Suggestions,it=function(r){var f=n.safeExecute(function(){return h(undefined,t,r.AccessUrl||r.Url,null,r.Text,r.FileName,r.FileExtension,r.FileSourceType=="OneDriveForBusiness"?"OneDriveBusiness":"SharePoint",r.DateModified?r.DateModified+"Z":null,r.ModifiedByDisplayName,r.DateAccessed?r.DateAccessed+"Z":null,r.CreatedBy||HitHighlightingParser.removeMarkers(r.Author),r.PropertyHits&&r.PropertyHits[0]=="Author",!1,function(){return s._substrateSuggestionsDataProvider.instrumentClick(u.Instrumentation.TraceId,r.ReferenceId)},i,y,a,"",null,r.SourceTitle)},"buildSubstrateDocumentSuggestion");f&&n.isValidSuggestion(f,"SubstrateDocumentsSuggestionsParser")&&o.push(f)},w=0,g=tt;w<g.length;w++)b=g[w],it(b);t.isSearchHomeZI||n.decorateSuggestionsWithParentFolder(o);break;case"People":for(rt=v.Suggestions,ut=function(f){var e=n.safeExecute(function(){return s.buildPersonSuggestion(l,f,i,u.Instrumentation.TraceId,a,r,t,c)},"buildPersonSuggestion");e&&n.isValidSuggestion(e,"SubstratePeopleSuggestionsParser")&&o.push(e)},k=0,nt=rt;k<nt.length;k++)b=nt[k],ut(b);l&&n.safeExecute(function(){return s.prefetchPeopleCards(o.filter(function(n){return n.type=="PPL"}),i,f)},"prefetchPeopleCards");n.isL2(t)||s.decorateContactsWithSameDisplayName(o,t);break;default:SharedLogHelper.LogError("parseSubstrateResponse",v.Type,new Error("Unexpected group type"))}e(r,o,null)};r=="SSUE"?n.LocalDataProvider.getApps(c,function(t){return v(!n.Map.isEmpty(t))}):v(!1)}},t.prototype.prefetchPeopleCards=function(t,i,r){t.length&&this.getPeopleCardTokenAndMailboxLocation(function(u){var o,f,e,s;u&&u.token&&u.location&&i==n.SequenceNumberManager.getSequenceNumber()&&r()&&(o=u.location+"api/v1/personacards/preparePersona",f=SearchAppWrapper.CortanaApp.createStringMap(),f.Authorization="Bearer "+u.token,f["X-ClientCorrelationId"]=n.InstrumentationHelper.getImpressionGuid(i),f["X-ClientType"]="6",e=SearchAppWrapper.CortanaApp.createStringMap(),e["Content-Type"]="application/json",s=JSON.stringify(t.map(function(n){return{Smtp:n.email,PersonaType:"User"}})),n.Promise.safeChain("prefetchPeopleCards",function(){return SearchAppWrapper.CortanaApp.makeHttpRequestAsync(1,o,f,s,e)},function(n){if(n.statusCode!=200&&n.statusCode!=204){var t=new Error("Prefetch request failed with status code: "+n.statusCode);SharedLogHelper.LogError("prefetchPeopleCards",null,t)}}))})},t.prototype.buildPersonSuggestion=function(t,i,r,u,f,o,s,h){var w=this,d,l,g,p,ft;if(!i.EmailAddresses||!i.EmailAddresses[0])return null;var et=i.PeopleType=="Group",nt=i.EmailAddresses[0],a=HitHighlightingParser.removeMarkers(nt),y,tt;et?y={content:"&#xE716",type:2}:(y=this._substrateProfilePictureProvider.getPersonDefaultIcon(i.DisplayName),tt=this._substrateProfilePictureProvider.getProfilePictureIcon(this._authType,a,y));var it=o=="SSUE",rt="PPL",c=n.createSuggestion(s,i.Text,tt,y,rt,i.DisplayName,n.InstrumentedItem.createInstrumentedItem(r,rt),it?8:12,r,!0),b=i.Id,k;it&&(d=i.Id.split("@"),b=d[0],k=d[1]);c.email=a;c.emailHH=nt;c.uniqueName=a;l=i.ImAddress;l&&!l.startsWith(e)&&(l=l.includes(":")?undefined:e+l);l&&(c.imAddress=l,g=l.substr(e.length),g!=a&&(c.alternativeEmail=g));p=b&&k&&!t;c.tooltip=this.getPersonTooltip(i.DisplayName,i.Department,i.JobTitle,i.OfficeLocation,i.CompanyName,a,c.alternativeEmail);c.instrumentPingBack=function(){return w._substrateSuggestionsDataProvider.instrumentClick(u,i.ReferenceId)};c.click=function(n){return w.onPersonSuggestionClick(t,p,a,c.query,r,n,b,k)};var ut=n.Host.getLocString("Email"),ot=function(){return n.Host.launchUri("mailto:"+a)},v={};return v[ut]=[{text:a,click:ot}],c.alternativeEmail&&(ft=function(){return n.Host.launchUri("mailto:"+c.alternativeEmail)},v[ut].push({text:c.alternativeEmail,click:ft})),i.OfficeLocation&&(v[n.Host.getLocString("Location")]=[{text:i.OfficeLocation}]),i.CompanyName&&(v[n.Host.getLocString("Company")]=[{text:i.CompanyName}]),c.previewMetadata=v,c.department=i.Department,this.setPersonTemplate(c,f,i.JobTitle,s),this.setPersonContextMenuItems(c,t||p,h),!n.RuntimeConfig.AlwaysWide&&(t||p)&&(c.calculateChildSuggestions=function(){return w.getPersonChildSuggestions(s,c,r,o,h)}),c},t.prototype.getPersonChildSuggestions=function(t,i,r,u,f){var e=[];e.push(this.getChildSuggestion(t,i,"CortanaAnnotation_Email","&#xE715","mailto:"+i.email,"PPLE",r));i.imAddress&&f&&e.push(this.getChildSuggestion(t,i,"SendInstantMessage","&#xE8BD",i.imAddress,"PPLM",r));i.childSuggestions=e;i.calculateChildSuggestions=null;n.InstrumentationHelper.instrumentDataSource(r,u,i.childSuggestions,null)},t.prototype.getChildSuggestion=function(t,i,r,u,f,e,o){var h=n.Host.getLocString(r),s=n.createSuggestion(t,h,null,{type:2,content:u},e,h,n.InstrumentedItem.createInstrumentedItem(o,e),i.handoffType,o,!1,null,null,!0);return s.parent=i,s.groupType=n.GroupType.Contact,s.click=function(){return n.Host.launchUri(f)},s.instrumentPingBack=i.instrumentPingBack,s},t.prototype.getPeopleCardTokenAndMailboxLocation=function(t){var i=this;this._accessTokenManager.getAccount(this._authType,this._authType==1?"394866fc-eedb-4f01-8536-3ff84b16be2a":"LiveProfileCard.Access",!1,!0,function(r){var u,e,o,f,s;if(!r||!r.Token){t(null);return}if(u=r.Token,e=i._mailboxLocations[r.RoutingHint],e){t({token:u,location:e});return}o=SearchAppWrapper.CortanaApp.createStringMap();f=SearchAppWrapper.CortanaApp.createStringMap();f.Authorization="Bearer "+u;f["X-ClientType"]="6";s="https://loki.delve.office.com/api/v1/configuration/cortana";n.Promise.safeChain("lokiConfiguration",function(){return SearchAppWrapper.CortanaApp.makeHttpRequestAsync(0,s,f,"",o)},function(f){if(f.statusCode!==200){t(null);return}n.Promise.safeChain("lokiConfigurationResponse",function(){return f.readAsStringAsync()},function(f){if(!f){t(null);return}var e=n.safeExecute(function(){return JSON.parse(f)},"parseLokiConfiguration");if(!e||!e.LokiUrl){t(null);return}i._mailboxLocations[r.RoutingHint]=e.LokiUrl;t({token:u,location:e.LokiUrl})},function(){return t(null)})},function(){return t(null)})})},t.prototype.getSharePointHost=function(n){for(var f,i,e,t,s,l,a,v=new DOMParser,u=0,h=n.value;u<h.length;u++)if(f=h[u],f.serviceElements)for(i=0,e=f.serviceElements;i<e.length;i++){var y=e[i],p=v.parseFromString(y,"text/xml"),r=p.getElementsByTagName("ServiceParameter"),o=void 0,c=!1;for(t=0;t<r.length;t++)if(s=r[t].getElementsByTagName("Name"),s[0].childNodes[0].nodeValue=="IsDefaultDataLocation"?(l=r[t].getElementsByTagName("Value"),l[0].childNodes[0].nodeValue=="True"&&(c=!0)):s[0].childNodes[0].nodeValue=="SPO_MySiteHost_AboutMeUrl"&&(a=r[t].getElementsByTagName("Value"),o=a[0].childNodes[0].nodeValue),c&&o)return o}return null},t.prototype.onPersonSuggestionClick=function(t,i,r,u,f,e,o,s){var c=this,h=function(){return n.Host.launchUri("mailto:"+r)},l=function(){var t=function(){return n.Host.launchUri(c._sharePointSiteHostUrl+"?aadObjectId="+o)};c._sharePointSiteHostUrl?t():c._accessTokenManager.getAccount(1,"https://graph.windows.net/",!1,!0,function(i){if(!i||!i.Token){h();return}var u=SearchAppWrapper.CortanaApp.createStringMap(),r=SearchAppWrapper.CortanaApp.createStringMap();r.Authorization="Bearer "+i.Token;n.Promise.safeChain("getSharePointUrl",function(){return SearchAppWrapper.CortanaApp.makeHttpRequestAsync(0,"https://graph.windows.net/"+s+"/tenantDetails/"+s+"/serviceInfo?api-version=1.6-internal",r,"",u)},function(i){if(i.statusCode!==200){h();return}n.Promise.safeChain("readSharePointUrlResponse",function(){return i.readAsStringAsync()},function(i){var r=i?n.safeExecute(function(){return JSON.parse(i)},"parseSharePointUrlResponse"):null;if(!r){h();return}c._sharePointSiteHostUrl=c.getSharePointHost(r);c._sharePointSiteHostUrl?t():h()},h)},h)})};t?this.getPeopleCardTokenAndMailboxLocation(function(t){if(f==n.SequenceNumberManager.getSequenceNumber())if(t&&t.token&&t.location){var o=t.location+"api/v1/personacard?clientType=Cortana&userSmtp="+r+"&ClientCorrelationId="+n.InstrumentationHelper.getImpressionGuid(f)+"&cts="+e+"&CultureInfoName="+n.uiLanguageCache;n.Host.launchWebContent(o,u,t.token)}else i?l():h()}):i?l():h()},t.prototype.setPersonContextMenuItems=function(t,i,r){n.setExtraVerbs(t,function(){var u=[],f=t.childSuggestions&&t.childSuggestions.some(function(n){return n.displayed});return f||(u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_SendEmail],displayName:n.Host.getLocString("CortanaAnnotation_Email"),executeSync:function(){return n.Host.launchUri("mailto:"+t.email)},isDefault:!i,icon:{content:"&#xE715",type:2}}),t.imAddress&&r&&u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_SendInstantMessage],displayName:n.Host.getLocString("SendInstantMessage"),executeSync:function(){return n.Host.launchUri(t.imAddress)},icon:{content:"&#xE8BD",type:2}})),SearchAppWrapper.CortanaApp.copyToClipboard&&u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_CopyPersonDetails],displayName:n.Host.getLocString("CopyDetails"),executeSync:function(){return SearchAppWrapper.CortanaApp.copyToClipboard(t.tooltip.replace(/\n/g,"\r\n"),"")},icon:{type:1,content:"&#xE8C8"}}),u},!0)},t.prototype.setPersonTemplate=function(t,i,r,u){var e=n.getEffectiveQuery(u),f;r?(t.jobTitle=r,t.primaryMetadata=r):t.text!=t.emailHH&&(t.primaryMetadata=t.emailHH);e&&(t.text.includes(HitHighlightingParser.startMarker)||(t.emailHH.includes(HitHighlightingParser.startMarker)?(t.template=1,t.primaryMetadata=t.emailHH):t.alternativeEmail&&(f=HitHighlightingParser.addMarkers(t.alternativeEmail,e),f.includes(HitHighlightingParser.startMarker)&&(t.template=1,t.primaryMetadata=f))));t.narratorText=n.getNarratorText(t);i?(t.template=u.isSearchHomeZI?0:1,u.isSearchHomeZI||t.classNames.push("people","topResultTemplateInGroups")):t.template==1&&t.classNames.push("forceNoWrapOutsideTopResult")},t.prototype.getPersonTooltip=function(n,t,i,r,u,f,e){var h="",c=[n,i,t,r,u],o,l,s;for(n!=f&&c.push(f),e&&n!=e&&c.push(e),o=0,l=c;o<l.length;o++)s=l[o],s&&(h+=h?"\n"+s:s);return h},t.prototype.decorateContactsWithSameDisplayName=function(t,i){for(var r,e,u,f=0;f<t.length-1;++f)if(r=t[f],r.type=="PPL")for(e=f+1;e<t.length;++e)if(u=t[e],u.type=="PPL"&&r.text.toLocaleLowerCase()==u.text.toLocaleLowerCase()){n.isL2(i)||(r.template!=1&&r.classNames.push("forceNoWrapOutsideTopResult"),u.template!=1&&u.classNames.push("forceNoWrapOutsideTopResult"));r.template=u.template=1;r.primaryMetadata=r.emailHH;u.primaryMetadata=u.emailHH;break}},t}();n.SubstrateSuggestionsParser=s;n.buildSubstrateDocumentSuggestion=h;n.formatDurationShorthand=f}(WSB||(WSB={})),function(n){function r(n,t){return function(){return n(t)}}function u(n){return encodeURIComponent(n.replace(/-/g,"/").replace(/_/g,"+"))}var f=["Microsoft.Office.OUTLOOK.EXE.15","Microsoft.Office.OUTLOOK.EXE.16","{6D809377-6AF0-444B-8957-A3773F02200E}Microsoft OfficeOffice15OUTLOOK.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}Microsoft OfficeOffice15OUTLOOK.EXE"],t="OutlookLaunchPref",i=[0,1],e="https://outlook.office365.com/mail/deeplink/attachment/{0}/{1}",o=function(){function o(n,t){this._substrateSuggestionsDataProvider=n;this._lightweightStorage=t;this._outlookLaunchPreference={}}return o.prototype.parse=function(t,i,r,u,f,e){var v=this,o,s,c,l,b,h,a,k;if(n.isDataSourceEnabled(r,t)){if(o=[],!u||!u.EntitySets){e(r,o,null);return}var y=n.getEffectiveQuery(t),p=n.getEffectiveScope(t),w=!1;for(s=0,c=u.EntitySets;s<c.length;s++)if(l=c[s],l.ResultSets)for(b=function(f){var b,h,s,l,k,e,a,c;if(f.Results)switch(p){case n.Scope.Emails:for(b=function(f){var e=n.safeExecute(function(){return v.buildMessageSuggestion(t,f.Source,i,r,u.Instrumentation?u.Instrumentation.TraceId:null,f.ReferenceId,y)},"buildMessageSuggestion");e&&n.isValidSuggestion(e,"parseSubstrateSearchResponse_emails",!1)&&o.push(e)},h=0,s=f.Results;h<s.length;h++)c=s[h],b(c);break;case n.Scope.Documents:case n.Scope.All:for(l=r=="SREE"?(e=(s=f.RecommendationsContext)===null||s===void 0?void 0:s.MeetingContext)===null||e===void 0?void 0:e.Source:null,k=function(r){var e=n.safeExecute(function(){return v.buildDocumentSuggestion(l,r.Source,i,u.Instrumentation?u.Instrumentation.TraceId:null,r.ReferenceId,r.Provenance||f.Provenance,y,t)},"buildDocumentSuggestion");e&&n.isValidSuggestion(e,"parseSubstrateSearchResponse_documents")&&o.push(e)},e=0,a=f.Results;e<a.length;e++)c=a[e],k(c);w=!l;break;default:SharedLogHelper.LogError("parseSubstrateSearchResponse",p.toString(),new Error("Unexpected scope"))}},h=0,a=l.ResultSets;h<a.length;h++)k=a[h],b(k);w&&n.decorateSuggestionsWithParentFolder(o);e(r,o,null)}},o.prototype.buildDocumentSuggestion=function(t,i,r,f,o,s,h,c){var it=this,p,w,d=h?HitHighlightingParser.addMarkers(i.FileName,h):i.FileName,l=d.includes(HitHighlightingParser.startMarker),v,y;if(h&&!l&&(!n.config.minLengthForContentMatch||c.queryToFetch.length<n.config.minLengthForContentMatch))return null;var g=i.Author==null?null:i.Author.DisplayName,b=n.matchesOnPropertyHH(g,h),rt=i.Description?n.decodeHtml(i.Description).replace(/<\/?[^>]+(>|$)/g,""):"",nt=n.tryGetTextContentMatch(rt,h),ut=nt[0],tt=nt[1],k=i.LastModifiedBy==null?null:i.LastModifiedBy.DisplayName,a;return l||b||(n.matchesOnPropertyHH(k,h)&&(a=n.createMatch(n.MatchType.LastModifiedBy,k)),a=a||tt),v=i.Url,y=i.WebUrl,s=="Exchange"&&(y=v,v=null,((p=i.LastShared)===null||p===void 0?void 0:p.AttachmentId)&&t.Id&&(y=n.formatString(e,[u(t.Id),u(i.LastShared.AttachmentId)]))),n.buildSubstrateDocumentSuggestion(t,c,v,y,d,i.FileName,i.FileExtension,s,i.LastModifiedDateTime,k,(w=i.UserRelationship)===null||w===void 0?void 0:w.LastAccessDateTime,g,!l&&b,!l&&!b&&!!tt,function(){return it._substrateSuggestionsDataProvider.instrumentClick(f,o)},r,h,n.isL2(c),ut,a,i.SiteTitle)},o.prototype.buildMessageSuggestion=function(t,i,r,u,f,e,o){var p=this,a,v,c,y;if(i.IsDraft)return null;if(!i.WebLink)return SharedLogHelper.LogError("buildMessageSuggestion",null,new Error("Missing web link")),null;if(a=i.From&&i.From.EmailAddress?i.From.EmailAddress.Name||i.From.EmailAddress.Address:null,v=i.Sender&&i.Sender.EmailAddress?i.Sender.EmailAddress.Name||i.Sender.EmailAddress.Address:null,!a&&!v)return SharedLogHelper.LogError("buildMessageSuggestion",null,new Error("No valid from or sender fields present")),null;var l=a||v,h=i.Subject,w=u=="SSEE",b="OLE",s=n.createSuggestion(t,HitHighlightingParser.addMarkers(l,o),null,null,b,h||l,n.InstrumentedItem.createInstrumentedItem(r,b),w?8:12,r,!0),k=w?1:2;return this.setEmailContextMenuItems(s,i.ItemHexId,i.WebLink,k),s.click=function(){return p.launchEmail(i.ItemHexId,i.WebLink,k)},s.template=1,s.classNames.push("email","forceNoWrapOutsideTopResult","topResultTemplateInGroups"),s.primaryMetadata=HitHighlightingParser.addMarkers(h,o),s.secondaryMetadata=HitHighlightingParser.addMarkers(i.Preview,o),s.tooltip=l+(h?"\n"+h:""),s.hc=i.SortOrderSource=="Relevance",s.previewIcon={content:"&#xE715",type:2,needsAccentColor:!0},i.HasAttachments&&(s.secondaryIcon={content:"&#xE723",type:2}),i.IsRead||s.classNames.push("accentColor"),i.DateTimeReceived&&(c=n.toDate(i.DateTimeReceived),y=n.getTodayTimeString(c),s.dateShort=y?y:c.toLocaleDateString(),s.dateLong=c.toLocaleString(navigator.language,{year:"numeric",month:"numeric",day:"numeric"}),s.dateAndTime=c.toLocaleString(navigator.language,{weekday:"long",month:"long",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric"})),s.internetMessageId=i.InternetMessageId,s.instrumentPingBack=function(){return p._substrateSuggestionsDataProvider.instrumentClick(f,e)},s.narratorText=n.getNarratorText(s),s.subject=HitHighlightingParser.addMarkers(h,o),s.from=l,s.to=i.DisplayTo,s.preview=i.Preview,s.hasAttachment=i.HasAttachments,s.importance=i.Importance!="Normal"?n.Host.getLocString("EmailImportance",i.Importance):"",s},o.prototype.setEmailContextMenuItems=function(t,i,r,u){var e=this;i&&n.setExtraVerbsAsync(t,function(){var t=[];return ThresholdUtilities.createPromise(function(o){n.LocalDataProvider.getApps(f,function(f){var a=!n.Map.isEmpty(f);if(a){var h=e.getOutlookLaunchPreference(u),c="Outlook",l,s=Object.keys(f);s.length==1&&(c=f[s[0]].deviceItem.displayName,l=f[s[0]].getIcon);t.push({verb:"OpenInOutlookWeb",displayName:n.Host.getLocString("OpenIn","Outlook Web"),executeSync:function(){return e.launchOutlookWeb(r,u)},isDefault:h==0,icon:{content:"&#xE774",type:1}});t.push({verb:"LaunchOutlookNative",displayName:n.Host.getLocString("OpenIn",c),executeSync:function(){return e.launchOutlokNative(i,u)},isDefault:h==1,getIcon:l})}o(t)})})},!0)},o.prototype.launchOutlookWeb=function(t,i,r){var u=this;n.Host.launchUri(t,!1,function(){return u.setOutlookLaunchPreference(0,i)},r)},o.prototype.launchOutlokNative=function(t,i,r){var u=this;n.Host.launchOutlook(t,function(){return u.setOutlookLaunchPreference(1,i)},r)},o.prototype.launchEmail=function(t,u,f){for(var c,e,s,l=this,v=this.getOutlookLaunchPreference(f),o=[v],h=0,a=i;h<a.length;h++)c=a[h],n.contains(o,c)||o.push(c);for(s=o.length-1;s>=0;s--)switch(o[s]){case 1:e=r(function(n){return l.launchOutlokNative(t,f,n)},e);break;case 0:e=r(function(n){return l.launchOutlookWeb(u,f,n)},e)}e()},o.prototype.getOutlookLaunchPreference=function(n){if(!this._outlookLaunchPreference[n]){var r=parseInt(this._lightweightStorage.getItem(t+n));this._outlookLaunchPreference[n]=isNaN(r)?i[0]:r}return this._outlookLaunchPreference[n]},o.prototype.setOutlookLaunchPreference=function(n,i){this._outlookLaunchPreference[i]=n;this._lightweightStorage.setItem(t+i,n.toString())},o}();n.SubstrateSearchParser=o}(WSB||(WSB={})),function(n){function r(){return i===t.Enabled}function u(){return i===t.Disabled}function f(){return i===t.Unknown}function e(){i=t.Disabled}function o(){i=t.Enabled}function s(){i=t.Unknown}function h(){return i}function c(t){return n.config.msbInternalTenants?n.contains(n.config.msbInternalTenants,t):!1}function l(n,t){return Math.random()*t+n}var t,i;(function(n){n[n.Unknown=0]="Unknown";n[n.Enabled=1]="Enabled";n[n.Disabled=2]="Disabled"})(t=n.TenantMsbStatus||(n.TenantMsbStatus={}));i=t.Unknown;n.isTenantMsbEnabled=r;n.isTenantMsbDisabled=u;n.isTenantMsbStatusUnknown=f;n.setTenantMsbDisabledStatus=e;n.setTenantMsbEnabledStatus=o;n.setTenantMsbUnknownStatus=s;n.getTenantMsbStatus=h;n.isMsbInternalTenant=c;n.getRandomNumInRange=l}(WSB||(WSB={})),function(n){function f(n,i){i?n.setItem(t,i):n.removeItem(t)}function e(n){return n.getItem(t)}var i=1440,r=360,u="MsbTenantSetting",o=function(){function t(t){this._localStorage=t;this._fetchingTenant=!1;this._tenantEnabledHandlers=[];this._tenantDisabledHandlers=[];n.config.msbCleanTenantSettingLocalStorage&&this.cleanLocalTenantSettingState()}return t.prototype.bindTenantEnabled=function(n){this._tenantEnabledHandlers.push(n)},t.prototype.bindTenantDisabled=function(n){this._tenantDisabledHandlers.push(n)},t.prototype.checkTenantSettings=function(t,i,r,u){var f=this,e=n.getCurrentTime();this.shouldGetTenantSettings(e,u===null||u===void 0?void 0:u.RoutingHint)?this.checkTenantSettingsFromServer(t,function(){f.checkTenantSettingsFromCache(t,i,r,u)},r,u):this.checkTenantSettingsFromCache(t,i,r,u)},t.prototype.checkTenantSettingsFromCache=function(n,t,i,r){var u=this.getLocalTenantSetting();u?(this.updateTenantFlags(u,r),n()):(this.cleanLocalTenantSettingState(),t())},t.prototype.checkTenantSettingsFromServer=function(t,i,r,u){var o=this;if(!this._fetchingTenant){this._fetchingTenant=!0;var s=_w.bfbWsbTel&&bfbWsbTel.getTenantId(),h=n.config.msbTenantApiUrl,c={url:h,onSuccess:function(f,e){var h,c,l;f&&f.tenantSettings?(h={isEnabled:f.tenantSettings.isEnabled,tenantDisplayName:f.tenantSettings.tenantDisplayName},o.updateTenantFlags(h,u),o.updateTenantSettingStateCache(u===null||u===void 0?void 0:u.RoutingHint,200,n.getCurrentTime(),h),o._fetchingTenant=!1,t()):(c="Response: "+JSON.stringify(f),l=n.isMsbInternalTenant(s)?c:"",_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Empty Tenant Settings","",{serverTraceId:e,statusCode:200,additionalMessage:l},{caller:r}),o._fetchingTenant=!1,i())},onError:function(h,c){var y="[MSB.Error] checkTenantSettings: onError: "+JSON.stringify({statusCode:h,ajaxErrorInfo:c}),l,a,v;l=h===404;l&&n.isTenantMsbStatusUnknown()&&(n.setTenantMsbDisabledStatus(),f(o._localStorage,null));a=n.getCurrentTime();h!==404?(v=o.getLocalTenantSetting(),o.updateTenantSettingStateCache(u===null||u===void 0?void 0:u.RoutingHint,h,a,v)):(o._tenantDisabledHandlers&&o._tenantDisabledHandlers.forEach(function(t){n.safeExecute(function(){return t()},"MsbTenantManager::fireTenantDisabled")}),o.updateTenantSettingStateCache(u===null||u===void 0?void 0:u.RoutingHint,404,a,{isEnabled:!1,tenantDisplayName:e(o._localStorage)}));var p=l?"Wsb Fetch Tenant Settings Non MSB":"Wsb Fetch Tenant Settings Failed",w=n.isMsbInternalTenant(s)?"ResponseText: "+(c===null||c===void 0?void 0:c.responseText)+", ErrorMessages: "+(c===null||c===void 0?void 0:c.errorMessage):"",b=n.isMsbInternalTenant(s)?c===null||c===void 0?void 0:c.stackTrace:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError(p,c===null||c===void 0?void 0:c.message,{stackTrace:b,serverTraceId:c===null||c===void 0?void 0:c.serverTraceId,statusCode:h,additionalMessage:w},{caller:r});o._fetchingTenant=!1;l?t():i()}};n.Msb.sendAjax(c)}},t.prototype.updateTenantSettingStateCache=function(n,t,i,r){var e=this.getTenantSettingStateFromCache(),o=e&&e.failedTimes,f;f=o+1;(t===200||t===404||t==-1)&&(f=0);var h=this.getNextIntervalWaitTime(t,f),c=this.createLocalTenantSettingState(i,h,f,n,r),s=JSON.stringify(c);this._localStorage.setItem(u,s)},t.prototype.shouldGetTenantSettings=function(n,t){var i=this.getTenantSettingStateFromCache(),r=!0;if(i){var u=i.lastTimestamp,f=i.nextRequestIntervalInMinutes,e=i.routingHint;t===e&&(r=n>u+f*6e4)}return r},t.prototype.cleanLocalTenantSettingState=function(){this._localStorage.removeItem(u)},t.prototype.getTenantSettingStateFromCache=function(){var n=this._localStorage.getItem(u),t=null;if(n)try{t=JSON.parse(n)}catch(i){this.cleanLocalTenantSettingState()}return t},t.prototype.getLocalTenantSetting=function(){var n=this.getTenantSettingStateFromCache();if(n!==null&&n!==void 0)return n.tenantSettings},t.prototype.updateTenantFlags=function(t,i){var r=t.isEnabled,u=t.tenantDisplayName;r?(n.setTenantMsbEnabledStatus(),f(this._localStorage,u),this._tenantEnabledHandlers&&this._tenantEnabledHandlers.forEach(function(t){n.safeExecute(function(){return t(i===null||i===void 0?void 0:i.RoutingHint)},"MsbTenantManager::fireTenantEnabled")})):(n.setTenantMsbDisabledStatus(),f(this._localStorage,null),this._tenantDisabledHandlers&&this._tenantDisabledHandlers.forEach(function(t){n.safeExecute(function(){return t()},"MsbTenantManager::fireTenantDisabled")}))},t.prototype.getNextIntervalWaitTime=function(t,u){var f=0,e;return t===200||t===404?f=n.getRandomNumInRange(i,r):u<=n.config.msbTenantSettingRetryNoWaitFailedTimes||t==-1?f=0:(e=(u-n.config.msbTenantSettingRetryNoWaitFailedTimes)*n.config.msbTenantSettingRetryInMin,f=t==503||t==429?f+e*3:f+e*4,f>=i+r&&(f=n.getRandomNumInRange(i,r))),f},t.prototype.createLocalTenantSettingState=function(n,t,i,r,u){return{lastTimestamp:n,nextRequestIntervalInMinutes:t,failedTimes:i,routingHint:r,tenantSettings:u}},t}(),t;n.MsbTenantManager=o;t="MsbTenantName";n.getStoredMsbTenantName=e}(WSB||(WSB={})),function(n){var t="AadUserId",i="MsbEnabledUserId",r="WsbVerifyAccountRequired",u=function(){function u(n,t,i){var r=this;this._accessTokenManager=n;this._localStorage=t;this._msbTenantManager=i;this._msbAccount=null;this._substrateAccount=null;this._userId=null;this._tenantId=null;this._tokenChanged=!1;this._tokenChangedHandlers=[];this._wsbAadReadyNotified=!1;this._accountTypeChangedIsFiring=!1;n.bindAccountTypesChanged(function(){r.handleAcountTypeChanged()});n.bindVerifyAccountRequired(function(n,t){r.handleWsbVerifyAccountRequired(n,t)});n.bindAccessTokenAvailable(function(n,t){r.handleWsbAccessTokenAvailable(n,t)});i.bindTenantEnabled(function(n){r.handleTanentEnabled(n)})}return u.prototype.bindTokenChanged=function(n){this._tokenChangedHandlers.push(n);var t=this.getMsbToken();t&&n(t)},u.prototype.refreshMsbTokenAndCall=function(t,i){var u=this,r=this.getMsbToken();r?n.safeExecute(function(){return t(r)},"MsbTokenManager::refreshMsbTokenAndCall:callback - cached token"):this.callGetAccount(!1,function(){var r=u.getMsbToken();r?n.safeExecute(function(){return t(r)},"MsbTokenManager::refreshMsbTokenAndCall:callback - fetched token"):i&&n.safeExecute(i,"MsbTokenManager::refreshMsbTokenAndCall:noTokenCallback")},"refreshMsbTokenAndCall")},u.prototype.getMsbToken=function(){if(!this._msbAccount||n.config.msbUse3sQuery&&!this._substrateAccount)return undefined;var t=n.getCurrentTime();return t>this._msbAccount.ExpireDateTime||n.config.msbUse3sQuery&&t>this._substrateAccount.ExpireDateTime?(this._msbAccount=null,this._substrateAccount=null,BingAtWork.wsb&&(BingAtWork.wsb.wsbAccessToken=null,BingAtWork.wsb.wsb3sAccessToken=null),undefined):this._msbAccount.Token},u.prototype.notifyWsbAadReady=function(){!this._wsbAadReadyNotified&&n.isTenantMsbEnabled()&&(this._wsbAadReadyNotified=!0,_w.postMessage({messageType:"BingAtWork:WsbAadReady",userId:this._userId,tenantId:this._tenantId},"*"))},u.prototype.callGetAccount=function(t,i,r){var u=this;if(!this._accessTokenManager.isAadAvailable()){n.setTenantMsbDisabledStatus();i&&i();this.clearUserTenantContext();this._msbTenantManager.cleanLocalTenantSettingState();return}this._accessTokenManager.getAccount(1,"9ea1ad79-fdb6-4f9a-8bc3-2b70f96e34c7",t,!0,function(f){n.config.msbUse3sQuery&&f&&f.Token?n.config.msbFetch3sToken?u.fetchMsb3sAccount(f.Token,function(t){n.safeExecute(function(){return u.handleSubstrateAccount(t)},"Calling handleSubstrateAccount");n.safeExecute(function(){return u.handleMsbAccount(f,i,r)},"Calling handleMsbAccount")},function(){n.safeExecute(function(){return u.handleMsbAccount(null,i,r)},"Calling handleMsbAccount with null 3s account")}):u._accessTokenManager.getAccount(1,"https://substrate.office.com",t,!0,function(t){n.safeExecute(function(){return u.handleSubstrateAccount(t)},"Calling handleSubstrateAccount");n.safeExecute(function(){return u.handleMsbAccount(f,i,r)},"Calling handleMsbAccount")}):n.safeExecute(function(){return u.handleMsbAccount(f,i,r)},"Calling handleMsbAccount")})},u.prototype.handleMsbAccount=function(i,r,u){var e=this,o=i&&i.Token,f;f=this.getAadUserInfo(i);this.updateTelemetryContext(f);f&&f.UserAadId&&this.trySendValueEvents(t,i===null||i===void 0?void 0:i.RoutingHint,{name:"LogAadUserId",value:""});o?(this.setMsbAccount(i),this._msbTenantManager.checkTenantSettings(function(){e.handleMsbTokenChanged();r&&r()},function(){e.handleMsbTokenChanged();r&&r()},u,this._msbAccount)):(n.setTenantMsbDisabledStatus(),r&&r())},u.prototype.handleSubstrateAccount=function(n){var t=n&&n.Token;t&&this.setSubstrateAccount(n)},u.prototype.fetchMsb3sAccount=function(t,i,r){var e=this,u,f;BingAtWork.wsb&&(BingAtWork.wsb.wsbAccessToken=t);u=n.config.msb3sTokenUrl.replace("{cvid}",BingAtWork.context.conversationId);f={url:u,onSuccess:function(t){var f=e.make3sAccount(t),u,o,s;f?i(f):(u="[MSB.Error] fetching 3S token returns no token. response="+JSON.stringify(t),o=_w.bfbWsbTel&&bfbWsbTel.getTenantId(),s=n.isMsbInternalTenant(o)?u:"",_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch 3S Token Returns Invalid Response","",{additionalMessage:s}),r())},onError:function(t,i){var o=i.responseText,s=i.message,h=i.stackTrace,c=i.serverTraceId,u="[MSB.Error] fetching 3S token has error, details="+JSON.stringify({statusCode:t,responseText:o,message:s,stackTrace:h,serverTraceId:c}),f,e;f=_w.bfbWsbTel&&bfbWsbTel.getTenantId();e=n.isMsbInternalTenant(f)?u:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch 3S Token Failed","",{additionalMessage:e});r()}};n.Msb.sendAjax(f)},u.prototype.make3sAccount=function(t){if(!t||!t.token||!t.tokenExpiry||!t.tenant||!t.tenant.id||!t.user||!t.user.id||!t.user.displayName)return undefined;var r=t.token,u=t.tokenExpiry,f=t.tenant.id,i=t.user,e=i.id,o=i.displayName;return{Token:r,ExpireDateTime:u,UserName:o,RoutingHint:"OID:"+f+":"+e,LastUpdated:n.getCurrentDate().getTime()}},u.prototype.updateTelemetryContext=function(n){this._userId=n===null||n===void 0?void 0:n.UserAadId;this._tenantId=n===null||n===void 0?void 0:n.TenantId;_w.bfbWsbTel&&bfbWsbTel.setUid(this._userId);_w.bfbWsbTel&&bfbWsbTel.setTenantId(this._tenantId)},u.prototype.setMsbAccount=function(n){var i=this._msbAccount&&this._msbAccount.Token,t=n.Token;this._msbAccount=n;BingAtWork.wsb&&(BingAtWork.wsb.wsbAccessToken=t);i!=t&&(this._tokenChanged=!0)},u.prototype.setSubstrateAccount=function(n){this._substrateAccount=n;BingAtWork.wsb&&(BingAtWork.wsb.wsb3sAccessToken=n.Token)},u.prototype.sendMsbProactiveSignIn=function(t){var i,r=(i={},i["Content-Type"]="text/plain",i),u={Authentication:t};n.fetchUrl(n.config.msbProactiveSigninUrl,r,JSON.stringify(u),function(){},undefined,undefined,!0,undefined,!0)},u.prototype.handleMsbTokenChanged=function(){if(this._tokenChanged&&n.isTenantMsbEnabled()){this._tokenChanged=!1;var t=this.getMsbToken();t&&(n.config.msbEnableProactiveSignin&&this.sendMsbProactiveSignIn(t),this._tokenChangedHandlers&&this._tokenChangedHandlers.forEach(function(i){n.safeExecute(function(){return i(t)},"MsbTokenManager::fireTokenChanged")}))}},u.prototype.handleWsbAccessTokenAvailable=function(n){var t=this;n==1&&(this._accountTypeChangedIsFiring||this.callGetAccount(!1,function(){t.notifyWsbAadReady()},"WsbAccessTokenAvailable"))},u.prototype.handleAcountTypeChanged=function(){var n=this;this._accountTypeChangedIsFiring=!0;this.callGetAccount(!0,function(){n.notifyWsbAadReady();n._accountTypeChangedIsFiring=!1},"AccountTypesChanged")},u.prototype.handleWsbVerifyAccountRequired=function(n,t){var u,i,f;switch(n){case 1:u="AAD";break;case 0:u="MSA";break;default:u="Unknown"}if(u!="MSA"){switch(t){case"9ea1ad79-fdb6-4f9a-8bc3-2b70f96e34c7":i="BingAtWork";break;case"https://www.bing.com/cortana":i="Cortana";break;case"https://graph.windows.net/":i="GraphWindowsApi";break;case"394866fc-eedb-4f01-8536-3ff84b16be2a":i="PeopleCard";break;case"https://outlook.office.com/":i="ProfilePictureApi";break;case"https://substrate.office.com":i="SubstrateEnterprise";break;case"service::cortana.bing.com::mbi_ssl":i="Cortana";break;case"LiveProfileCard.Access":i="PeopleCard";break;case"https://outlook.office.com/User.ReadWrite":i="ProfilePictureApi";break;case"https://substrate.office.com/SubstrateSearch-Internal.ReadWrite":i="SubstrateConsumer";break;default:i="Unknown"}f=u+"@"+i;this.trySendValueEvents(r,f,{name:"WsbVerifyAccountRequired",value:"",kv:{authType:u,resourceOrScope:i}})}},u.prototype.getAadUserInfo=function(n){var t=n===null||n===void 0?void 0:n.RoutingHint,i,r;return t&&t.startsWith("OID:")&&t.length==77?(i=t.substring(4,40),r=t.substring(41),{TenantId:r,TenantName:n.TenantName,UserAadId:i}):null},u.prototype.clearUserTenantContext=function(){_w.bfbWsbTel&&bfbWsbTel.setUid(null);_w.bfbWsbTel&&bfbWsbTel.setTenantId(null)},u.prototype.isThrottledLogInfoExpired=function(t,i){var f=this._localStorage.getItem(i),r=this.parseCachedLogInfo(f),u;return r==null?!0:r.LogKey!=t?!0:(u=n.config.msbLogThrottlingTimeInHours*36e5,n.getCurrentTime()>r.SavedTimestamp+u)?!0:!1},u.prototype.parseCachedLogInfo=function(n){var t=n&&n.split(";");return!t||t.length!=2?null:{LogKey:t[1],SavedTimestamp:+t[0]}},u.prototype.updateLogInStorage=function(t,i){var r=n.getCurrentTime()+";"+i;this._localStorage.setItem(t,r)},u.prototype.handleTanentEnabled=function(n){this.trySendValueEvents(i,n,{name:"LogMsbEnabledUserId",value:""})},u.prototype.trySendValueEvents=function(n,t,i){this.isThrottledLogInfoExpired(t,n)&&(_w.bfbWsbTel&&i&&bfbWsbTel.logValue(i.name,i.value,i.kv),this.updateLogInStorage(n,t))},u}();n.MsbTokenManager=u}(WSB||(WSB={})),function(n){var t,i=(t={},t.Person="People",t.Group="Group",t.Bookmark="Bookmark",t.Building="Building",t.Qna="EditorialQnA",t),r=function(){function t(){this._lastMiniSerpSearchId=null;this._lastMiniSerpLoadedHandler=null;this.setupMiniSerpPrefetch()}return t.prototype.fetchServerSuggestion=function(t,i,r,u){var f={query:t,count:i,domains:r,clientContext:{clientType:"Wsb"}},e=JSON.stringify(f),o={url:n.config.msbServerQfUrl,requestType:"POST",body:e,onSuccess:function(n){u(n&&n.results)},onError:function(){u([])}};n.Msb.sendAjax(o)},t.prototype.fetchSearchResponse=function(t,i,r,u){n.config.msbUse3sQuery?this.fetchMsb3sQueryResponse(t,i,r,u):this.fetchMsbSearchResponse(t,i,r,u)},t.prototype.fetchMsb3sQueryResponse=function(t,i,r,u){var o=this,s=n.config.msb3sQueryUrl,f=this.buildMsb3sQueryRequest(t,i),h=JSON.stringify(f),e;this.fireResetSearchOptions();e={url:s,useToken:"WSB3S",requestType:"POST",body:h,onSuccess:function(e,o){var s,h,c;e?e.AnswerEntitySets&&e.AnswerEntitySets.length!=0?r(e,f):(s="[MSB.Error] fetchMsb3sQueryResponse received empty searchResponse or searchResponse.results for query "+t,h=_w.bfbWsbTel&&bfbWsbTel.getTenantId(),c=n.isMsbInternalTenant(h)?s:"",_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Search Response Empty Results","",{serverTraceId:o,additionalMessage:c}),u()):(s="[MSB.Error] fetchMsb3sQueryResponse received empty response for query "+t+" of intent "+i,_w.bfbWsbTel&&bfbWsbTel.logError("Wsb 3S Query Response is Empty","",{serverTraceId:o}),u())},onError:function(r,f){var o=f.responseText,s=f.message,h=f.stackTrace,c=f.serverTraceId,l="[MSB.Error] fetchMsb3sQueryResponse failed, details="+JSON.stringify({queryText:t,intent:i,statusCode:r,responseText:o,message:s,stackTrace:h,serverTraceId:c});var e=_w.bfbWsbTel&&bfbWsbTel.getTenantId(),a=n.isMsbInternalTenant(e)?"Query: "+t+", intent: "+i+", responseText: "+(f===null||f===void 0?void 0:f.responseText)+", errorMEssage: "+f.errorMessage:"",v=n.isMsbInternalTenant(e)?f===null||f===void 0?void 0:f.stackTrace:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Search Response Failed",f===null||f===void 0?void 0:f.message,{stackTrace:v,serverTraceId:f===null||f===void 0?void 0:f.serverTraceId,statusCode:r,additionalMessage:a});u()},onRoundTripReport:function(n){o.fireRoundTripTime("SubstrateSearch_RoundTripTime",n)}};n.Msb.sendAjax(e)},t.prototype.fetchMsbSearchResponse=function(t,i,r,u){var s=this,o;var h=this.getMsbUrl("search"),e=this.buildMsbSearchRequest(t,i),c=JSON.stringify(e),l=n.Host.createGuid(),f=_w.bfbWsbTel&&bfbWsbTel.getTenantId();this.fireResetSearchOptions();o={url:h,requestType:"POST",body:c,onSuccess:function(o,s){var c,h,a;o?(c=o,c.results&&c.results.length!=0?(c.wsbRequestId=l,r(c,e)):(h="[MSB.Error] fetchMsbSearchResponse received empty searchResponse or searchResponse.results for query "+t,a=n.isMsbInternalTenant(f)?h:"",_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Search Response Empty Results","",{serverTraceId:s,additionalMessage:a}),u())):(h="[MSB.Error] fetchMsbSearchResponse received empty response for query "+t+" of intent "+i,a=n.isMsbInternalTenant(f)?h:"",_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Search Response is Empty","",{serverTraceId:s,additionalMessage:a}),u())},onError:function(r,e){var h=e.responseText,c=e.message,l=e.stackTrace,a=e.serverTraceId,v="[MSB.Error] fetchMsbSearchResponse failed, details="+JSON.stringify({queryText:t,intent:i,statusCode:r,responseText:h,message:c,stackTrace:l,serverTraceId:a}),o,s;o=n.isMsbInternalTenant(f)?"Query: "+t+", intent: "+i+", responseText: "+(e===null||e===void 0?void 0:e.responseText)+", errorMEssage: "+e.errorMessage:"";s=n.isMsbInternalTenant(f)?e===null||e===void 0?void 0:e.stackTrace:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Search Response Failed",e===null||e===void 0?void 0:e.message,{stackTrace:s,serverTraceId:e===null||e===void 0?void 0:e.serverTraceId,statusCode:r,additionalMessage:o});u()},onRoundTripReport:function(n){s.fireRoundTripTime("Search_RoundTripTime",n)}};n.Msb.sendAjax(o)},t.prototype.getPersonPhotoData=function(t,i,r){var u=this.getMsbUrl(i?"person/photo":"group/photo"),f={clientContext:{clientType:"Wsb"},id:t},e=JSON.stringify(f),o={url:u,requestType:"POST",body:e,onSuccess:function(n){n&&n.imageInBase64?r("data:image/jpeg;base64,"+n.imageInBase64):r(null)}};n.Msb.sendAjax(o)},t.prototype.fireResetSearchOptions=function(){var t={messageType:"MSB_RESET_SEARCH_OPTIONS"};n.safeExecute(function(){window.postMessage(t,window.location.origin)},"fireResetSearchOptions")},t.prototype.fireSearchResponse=function(t,i){n.config.msbUse3sQuery?this.fireMsb3sQueryResponse(t,i):this.fireMsbSearchResponse(t,i)},t.prototype.fireMsb3sQueryResponse=function(t,i){var r=this.buildMsb3sQueryRequest(t),u=n.Host.createGuid(),f={messageType:"MSB_SET_3S_QUERY_RESPONSE",payload:{requestId:u,request:r,response:i}};n.safeExecute(function(){window.postMessage(f,window.location.origin)},"fireSearchResponse")},t.prototype.fireMsbSearchResponse=function(t,i){var r=this.buildMsbSearchRequest(t),u={messageType:"MSB_SET_SEARCH_RESPONSE",payload:{requestId:i.wsbRequestId,request:r,response:i}};n.safeExecute(function(){window.postMessage(u,window.location.origin)},"fireSearchResponse")},t.prototype.fireRoundTripTime=function(t,i){var r=Object.assign({eventId:t},i),u;u={messageType:"MSB_SEARCH_RTT",payload:r};n.safeExecute(function(){window.postMessage(u,window.location.origin)},"fireRoundTripTime")},t.prototype.getMsbUrl=function(t){return t==="search"?n.config.msbApiBaseUrl:n.config.msbApiBaseUrl+"/"+t},t.prototype.buildMsb3sQueryRequest=function(n,t){var r=i[t],u=r!=null?[r]:[];return{Cvid:BingAtWork.context.conversationId,AnswerEntityRequests:[{Query:{QueryString:n},EntityTypes:u,From:0,Size:1}],Scenario:{Name:"Wsb.PreviewPane"},TextDecorations:"Off"}},t.prototype.buildMsbSearchRequest=function(t,i){return{query:t,requestContext:{clientSize:"Small",queryIntent:i},clientContext:{clientType:"Wsb",timeZoneOffsetInMinutes:-1*n.getCurrentDate().getTimezoneOffset()}}},t.prototype.setupMiniSerpPrefetch=function(){n.config.msbEnableMiniSerp&&n.config.msbEnableMiniSerpPrefetch&&!n.config.msbUse3sQuery&&(this.handleMiniSerpFetch=this.handleMiniSerpFetch.bind(this),sj_evt.unbind(n.MiniSerpFetchEvent,this.handleMiniSerpFetch),sj_evt.bind(n.MiniSerpFetchEvent,this.handleMiniSerpFetch))},t.prototype.handleMiniSerpFetch=function(i){var r=this,u=i&&i.length>1&&i[1],f=u&&u.query;f&&(this._lastMiniSerpSearchId&&this._lastMiniSerpLoadedHandler&&(sj_evt.unbind(n.MiniSerpLoadedEvent,this._lastMiniSerpLoadedHandler),this._lastMiniSerpSearchId=null,this._lastMiniSerpLoadedHandler=null),this._lastMiniSerpSearchId=n.Host.createGuid(),this.fetchSearchResponse(f,undefined,function(i,u){r._lastMiniSerpLoadedHandler=function(){var r=function(f){var o=_ge(n.MiniSerpIframeId),e=o&&o.contentWindow;if(!e.sj_evt||!e.BingAtWork){f>0&&sb_st(function(){return r(f-1)},50);return}e.BingAtWork.wsb=BingAtWork.wsb;e.BingAtWork.searchPrefetchRequest=u;e.sj_evt.fire(t.MsbSearchReadyEvent,i,u)};r(200)};sj_evt.bind(n.MiniSerpLoadedEvent,r._lastMiniSerpLoadedHandler)},function(){}))},t.MsbSearchReadyEvent="bfbCommand",t}();n.MsbDataAccess=r}(WSB||(WSB={})),function(n){function i(){var i;return{domainOptions:(i={},i.Person={spaceInTheMiddleRequired:!1,minimumMatchCount:n.config.msbMinMatchPerson||t},i.Bookmark={minimumMatchCount:n.config.msbMinMatchBookmark||t},i.Building={minimumMatchCount:n.config.msbMinMatchBuilding||t},i.Group={minimumMatchCount:n.config.msbMinMatchGroup||t},i.Qna={minimumMatchCount:n.config.msbMinMatchQna||t},i),ignoreChars:"parenDash"}}function c(){var t=i().domainOptions,n=Number.MAX_VALUE;for(var r in t)n=t[r].minimumMatchCount<n?t[r].minimumMatchCount:n;return{minimumQueryLength:n}}function l(t){return n.isL2(t)?t.scope===n.Scope.People?s:t.scope===n.Scope.Web?h:undefined:o}function a(){var t=["Person","Bookmark","Group","Qna"];return n.config.msbDisableBuilding||t.push("Building"),t}function v(){var t=["Bookmark","Qna"];return n.config.msbDisableBuilding||t.push("Building"),t}var u="CS",f="NT",e="NE",t=6,r="msb:qf:atrdy",o={suggestionConfidenceOptions:i(),serverSuggestionOptions:c(),domains:a(),count:n.config.msbQfResultsCountL1},s={suggestionConfidenceOptions:i(),domains:["Person","Group"],count:n.config.msbQfResultsCountL2},h={suggestionConfidenceOptions:i(),domains:v(),count:n.config.msbQfResultsCountL2},y=function(){function t(t,i){var u=this,f;this._dataSource=t;this._msbTokenManager=i;this._tokenChangedFired=!1;this._clientQfReadyFired=!1;this._clientQfTokenReady=!1;this._logId=this.getName()+"["+this._dataSource+"]";this._msbDataModule=_w.BingAtWork;this._msbTokenManager.bindTokenChanged(function(){u._tokenChangedFired=!0;u.updateClientQfAccessToken()});f=function(){u._clientQfReadyFired=!0;u.updateClientQfAccessToken();sj_evt.unbind(r,f)};sj_evt.bind(r,f,!0,null,!0);this._fetchClientQfResponse=n.config.msbServerBackfill?this.fetchSuggestionsWithServerBackfill:this.fetchLocalSuggestions}return t.prototype.getName=function(){return"MsbClientQfDataProvider"},t.prototype.fetch=function(t,i,r,f,o){if(n.isDataSourceEnabled(this._dataSource,t)){if(!n.isTenantMsbEnabled()){i(this._dataSource,null,e);return}if(!(this.isClientQfReady()&&this._clientQfTokenReady)){i(this._dataSource,null,u);return}var s=l(t);if(!s){i(this._dataSource,null,null);return}this.getAcessTokenAndFederate(t,i,o,f,s)}},t.prototype.getAcessTokenAndFederate=function(n,t,i,r,u){var e=this;this._msbTokenManager.refreshMsbTokenAndCall(function(){e._fetchClientQfResponse(n,t,i,u)},function(){t(e._dataSource,null,f)})},t.prototype.fetchSuggestionsWithServerBackfill=function(n,t,i,r){var u=this,f={isFirstStageProcessed:!1,enoughSuggestionsReceived:!1};this._msbDataModule.getExtraSuggestions(n.queryToFetch,function(n){u.processClientQfResponseTwoStage(n,t,f,i,r)},function(n){u.processClientQfResponseTwoStage([],t,f,i,r)});this._msbDataModule.getSuggestions(n.queryToFetch,function(n){u.processClientQfResponseTwoStage(n,t,f,i,r)},function(n){u.processClientQfResponseTwoStage([],t,f,i,r)},r)},t.prototype.fetchLocalSuggestions=function(n,t,i,r){var u=this;this._msbDataModule.getExtraSuggestions(n.queryToFetch,function(n){},function(n){});this._msbDataModule.getSuggestions(n.queryToFetch,function(n){u.processClientQfResponse(n,t,i)},function(n){},r)},t.prototype.processClientQfResponse=function(n,t,i){if(i()){if(!n){t(this._dataSource,null,null);return}var r=n;t(this._dataSource,r,null)}},t.prototype.processClientQfResponseTwoStage=function(n,t,i,r,u){if(r()&&!i.enoughSuggestionsReceived){n||(n=[]);i.enoughSuggestionsReceived=u.count&&n.length>=u.count;var f=!(i.enoughSuggestionsReceived||i.isFirstStageProcessed);t(this._dataSource,n,null,0,!1,f);i.isFirstStageProcessed=!0}},t.prototype.isClientQfReady=function(){var n=BingAtWork.msbDataContext;return n&&n.initializeFired&&n.readyFired},t.prototype.updateClientQfAccessToken=function(){var i=this,t;this._tokenChangedFired&&this._clientQfReadyFired&&n.isTenantMsbEnabled()&&(t=this._msbTokenManager.getMsbToken(),t&&this._msbDataModule.setAccessToken(t,function(){i._clientQfTokenReady=!0},function(n){}))},t}();n.MsbClientQfDataProvider=y}(WSB||(WSB={}));__spreadArrays=this&&this.__spreadArrays||function(){for(var i=0,n=0,r=arguments.length;n<r;n++)i+=arguments[n].length;for(var u=Array(i),f=0,n=0;n<r;n++)for(var e=arguments[n],t=0,o=e.length;t<o;t++,f++)u[f]=e[t];return u},function(n){function c(n,t){t(h)}var t,i="BFBWSL",r=1,e=.6,u=2,f=/[0-9a-zA-Z]/,o=/\s+/g,s=(t={},t.Person="MPPL",t.Group="MGRP",t.Bookmark="MBKS",t.Building="MBLD",t.Qna="MQNA",t),h={type:0,className:"msb-suggIcon",content:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDQ4IDIwNDgiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+DQogIDxwYXRoIGQ9Ik0xNzYyIDE1OTBxNjYgMzIgMTE4IDgwdDkwIDEwOCA1OCAxMjggMjAgMTQyaC0xMjhxMC03OS0zMC0xNDl0LTgzLTEyMi0xMjItODItMTQ5LTMxcS03OSAwLTE0OSAzMHQtMTIyIDgzLTgyIDEyMi0zMSAxNDloLTEyOHEwLTczIDIwLTE0MXQ1Ny0xMjggOTAtMTA4IDExOS04MXEtNzUtNTQtMTE2LTEzNXQtNDItMTc1cTAtNzkgMzAtMTQ5dDgyLTEyMiAxMjItODMgMTUwLTMwcTc5IDAgMTQ5IDMwdDEyMiA4MiA4MyAxMjMgMzAgMTQ5cTAgOTMtNDEgMTc0dC0xMTcgMTM2em0tMjI2LTU0cTUzIDAgOTktMjB0ODItNTUgNTUtODEgMjAtMTAwcTAtNTMtMjAtOTl0LTU1LTgyLTgxLTU1LTEwMC0yMHEtNTMgMC05OSAyMHQtODIgNTUtNTUgODEtMjAgMTAwcTAgNTMgMjAgOTl0NTUgODIgODEgNTUgMTAwIDIwem01MTItMTQwOHYxMDI0cTAtNDgtOS04NHQtMjUtNjctNDAtNjAtNTQtNjNWMjU2SDEyOHYxMTUyaDI1NnYyNjdsMjY3LTI2N2gzOTBxOCAzNCAyMSA2NnQzMSA2Mkg3MDRsLTQ0OCA0NDh2LTQ0OEgwVjEyOGgyMDQ4eiIgLz4NCjwvc3ZnPg=="},l=function(){function t(n){this._msbDataAccess=n;this.bookmarkIcon={content:"&#xEB8F",type:2};this.locationIcon={content:"&#xECAF",type:2}}return t.prototype.parse=function(t,i,r,u,f,e){var o,s;if(n.isDataSourceEnabled(r,t)&&u){if(!u||u.length<1){e(r,[],null);return}o=this.pickUpClientQfResults(t,u);this.createClientQfSuggestionsFor(t,i,o);s=o.map(function(n){return n.wsbSuggestion});e(r,s,null)}},t.prototype.setRankingValues=function(n,t,i){n.suggestionLogMeta='40000:"'+t+'";40001:"'+i+'"'},t.prototype.createMsbSuggestion=function(t,i,r,u,f,e,o,h,c,l,a,v){var p=s[o],y=n.createSuggestion(t,HitHighlightingParser.addMarkers(i,t.originalQuery),u,f,p,i,n.InstrumentedItem.createInstrumentedItem(e,p),17,e,!0),w;r&&(y.autoOpenPreviewPaneWhenOnTopHit=!0,y.allowedInGroups=!0);c&&(y.primaryMetadata=c);y.previewCallback=a;y.click=v;y.msbDomain=o;y.msbId=h;l&&(y.classNames=(y.classNames||[]).concat(l));switch(p){case"MPPL":n.isL2(t)&&(y.sourceForGroup=6);break;case"MGRP":n.isL2(t)&&(y.sourceForGroup=5);break;default:w=n.SubstrateTenantName||"";y.groupDisplayName=n.Host.getLocString("TenantBookmarksGroup",w)}return y},t.prototype.createGetPersonIcon=function(t,i,r){var u=this;return n.Promise.safeChainWithGlobalCaching("createGetPersonIcon",function(){return ThresholdUtilities.createPromise(function(n){u._msbDataAccess.getPersonPhotoData(t,i,function(t){t&&n(t)})})},function(){return t},function(t){return n.toIcon(t,"createGetPersonIcon")},r,null,null,3)},t.prototype.getDefaultIcon=function(n){var t,i=n.trim().replace(o," ").split(" ",2),r,u;return i.length>0&&(r=i[0][0],f.test(r)&&(t=r),i.length==2&&(u=i[1][0],t&&f.test(u)?t+=u:t="")),{type:t?5:2,content:t?t.toUpperCase():"&#xE77B",className:"peopleIcon"}},t.prototype.buildPreviewResponse=function(n,t,i,r){var o,f;n.normalizedQuery=r;n.ranking.entityCards=[{cardType:"Hero",domain:t,entityIds:[i]}];n.ranking.placement="Carousel";var e=n.results.filter(function(n){return n.domain===t}),s=n.results.filter(function(n){return n.domain!==t}),u=e&&e[0],h=u&&u.results&&u.results.filter(function(n){return n.id===i}),c=u&&u.results&&u.results.filter(function(n){return n.id!==i});return u&&(f=[],h&&f.push.apply(f,h),c&&f.push.apply(f,c),u.results=f),n.results=e||[],s&&(n.results=(o=n.results).concat.apply(o,s)),n},t.prototype.pickUpClientQfResults=function(t,i){for(var f,h,o,s=!1,y=0,p=n.isL2(t),a=[],c=[],l=0,v=i;l<v.length;l++)(f=v[l],f.domain!=="Group"||f.identifiers!=null&&f.identifiers.uniqueName!=null)&&(f.confidence==="High"?(s=!0,o={msbSuggestion:f,isHero:!p&&y++<u,score:r},a.push(o)):(s||f.confidence==null||(s=!0),o={msbSuggestion:f,isHero:!1,score:e},c.push(o)));if(!s)for(h=0;h<u;h++)o=c[h],o&&(o.isHero=!0,o.score=r);return __spreadArrays(a,c)},t.prototype.createClientQfSuggestionsFor=function(n,t,i){for(var u,f,r=0;r<i.length;r++)u=i[r],f=this.buildClientQfSuggestion(n,t,u),this.setRankingValues(f,r,u.score),u.wsbSuggestion=f},t.prototype.buildClientQfSuggestion=function(t,r,u){var l=this,f=u.msbSuggestion,k=u.isHero,h=f.query,a=f.query,v=undefined,o=undefined,p=undefined,s=undefined,w,e,b,y;switch(f.domain){case"Bookmark":o=this.bookmarkIcon;w=f.identifiers;s=function(){n.Host.launchUri(w.url)};break;case"Person":e=this.getDefaultIcon(h);v=this.createGetPersonIcon(f.id,!0,e);o=e;p="msb-people";s=function(){var t=f.identifiers,r=n.buildBfbSearchUrl(n.config,a,"Person",t.uniqueName,i);n.Host.launchUri(r)};break;case"Group":e=this.getDefaultIcon(h);v=this.createGetPersonIcon(f.id,!1,e);o=e;p="msb-people";s=function(){var t=f.identifiers,r=n.buildBfbSearchUrl(n.config,a,"Group",t.uniqueName,i);n.Host.launchUri(r)};break;case"Building":o=this.locationIcon;s=function(){var t=n.buildBfbSearchUrl(n.config,a,"Building",undefined,i);n.Host.launchUri(t)};break;case"Qna":e=this.getDefaultIcon(h);v=c;o=e;s=function(){var t=n.buildBfbSearchUrl(n.config,a,"Qna",undefined,i);n.Host.launchUri(t)}}return b=function(t,i){var r=f.query;(f.domain==="Person"||f.domain==="Group")&&(r=f.identifiers&&f.identifiers.uniqueName||r);l._msbDataAccess.fetchSearchResponse(r,f.domain,function(t){if(i(f.id,f.domain))if(n.config.msbUse3sQuery)l._msbDataAccess.fireSearchResponse(r,t);else{var u=t,e=l.buildPreviewResponse(u,f.domain,f.id,h);l._msbDataAccess.fireSearchResponse(r,e)}},function(){t(f.query)})},y=this.createMsbSuggestion(t,h,k,v,o,r,f.domain,f.id,f.title,p,b,s),n.isL2(t)&&t.scope===n.Scope.People&&(y.template=1,y.classNames.push("people","topResultTemplateInGroups")),y},t}();n.MsbQfSuggestionsParser=l}(WSB||(WSB={})),function(n){var t;(function(t){function r(t,r){var e,o,s,l,a;if(t!=null&&t.url){if(e=function(n,i){if(t.onError!=null)t.onError(n,i)},t.useToken==="WSB3S"){if(o=_w.BingAtWork&&_w.BingAtWork.wsb&&_w.BingAtWork.wsb.wsb3sAccessToken,!o){e(i.NoWsbAccessToken,{message:"MsbDataAccess.sendAjax: no WSB/3S access token, won't send the request."});return}}else if(o=_w.BingAtWork&&_w.BingAtWork.wsb&&_w.BingAtWork.wsb.wsbAccessToken,!o){e(i.NoWsbAccessToken,{message:"MsbDataAccess.sendAjax: no WSB access token, won't send the request."});return}t.url[0]==="/"&&(t.url=(_w==null?"":_w.location.origin)+t.url);s=0;switch(t.requestType){case"POST":s=1;break;case"PUT":s=4}var h=SearchAppWrapper.CortanaApp,v=h.createStringMap(),c=h.createStringMap();c.Authorization="Bearer "+o;c.Accept="*/*";v["Content-Type"]="application/json";l=performance.now();a=new Date;n.Promise.safeChain("makeHttpRequestAsync_MsbDataAccess_Ajax",function(){return h.makeHttpRequestAsync(s,t.url,c,t.body||"",v)},function(o){var s;if(t.onRoundTripReport){var h=f(o),c=o.statusCode==200?undefined:"HTTP"+o.statusCode,v=performance.now(),y=new Date,p=o.statusCode;t.onRoundTripReport({startTime:l,endTime:v,startDateTime:a,endDateTime:y,serverLatency:h,errorMessage:c,status:p})}s=u(o);o.statusCode===200?n.Promise.safeChain("readResponse",function(){return o.readAsStringAsync()},function(n){if(t.onSuccess!=null){var u=null;if(n!=="")try{u=r?n:JSON.parse(n)}catch(f){e(i.ResponseJsonParseError,{message:"Bad data",responseText:n,serverTraceId:s});return}t.onSuccess(u,s)}},function(n){e(i.ReadResponseError,{message:"readAsStringAsync_makeHttpRequestAsync_MsbAjax Error",errorMessage:"Name: "+n.name+", message: "+n.message,stackTrace:""+n.stack,serverTraceId:s})},null,null,0):n.Promise.safeChain("readNon200Response",function(){return o.readAsStringAsync()},function(n){e(o.statusCode,{message:"Ajax call failed with status "+o.statusCode.toString()+". No retries attempted.",responseText:n,serverTraceId:s})},function(n){e(i.ReadResponseError,{message:"readAsStringAsync_Non200_makeHttpRequestAsync_MsbAjax Error",errorMessage:"Name: "+n.name+", Message: "+n.message,stackTrace:""+n.stack,serverTraceId:s})},null,null,0)},function(n){if(t.onRoundTripReport){var r=performance.now(),u=new Date,f=i.MsbAjaxMakeHttpRequestAsyncError;t.onRoundTripReport({startTime:l,endTime:r,startDateTime:a,endDateTime:u,errorMessage:"Promise error makeHttpRequestAsync_MsbAjax Error",status:f})}e(i.MsbAjaxMakeHttpRequestAsyncError,{message:"Promise error makeHttpRequestAsync_MsbAjax Error",errorMessage:"Name: "+n.name+", Message: "+n.message+", RequestType: "+s+", RequestUrl: "+t.url+" ",stackTrace:""+n.stack})},null,null,0)}}function u(n){var t,i=(t=n===null||n===void 0?void 0:n.headers)===null||t===void 0?void 0:t["x-msedge-ref"];return i&&i.substring(7,i.indexOf(" Ref B:"))}function f(n){var t;if((t=n===null||n===void 0?void 0:n.headers)!==null&&t!==void 0)return t["x-end2endlatencyms"]}t.sendAjax=r;var i;(function(n){n[n.MsbAjaxMakeHttpRequestAsyncError=-1]="MsbAjaxMakeHttpRequestAsyncError";n[n.ResponseJsonParseError=-2]="ResponseJsonParseError";n[n.ReadResponseError=-3]="ReadResponseError";n[n.ReadErrorStatusResponseError=-4]="ReadErrorStatusResponseError";n[n.NoWsbAccessToken=-5]="NoWsbAccessToken"})(i||(i={}))})(t=n.Msb||(n.Msb={}))}(WSB||(WSB={}))